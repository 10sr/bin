#!/bin/sh
set -eu

export DTACH_CURRENT_SOCK=${DTACH_CURRENT_SOCK:=}

__dt(){
    # dt [-h] [<name>] [<command ...>]

    if test -n "${DTACH_CURRENT_SOCK}"
    then
        # if already in dtach session print current session
        soc_name="`basename "$DTACH_CURRENT_SOCK"`"
        echo "Current dtach socket: ${soc_name}"
    fi

    if test $# -eq 0
    then
        # if no arg given show list of sessions
        echo "Usage: dt [-h] [<sock_file>] [<command ...>]" 1>&2
        return 0
    elif test "$1" = "-h"
    then
        echo "dt: usage: dt [-h] [<name>] [<command ...>]" 1>&2
        return 0
    fi

    # set socket path
    # TODO: How to get absolute path of $1?
    soc="$1"
    shift

    if test -n "$DTACH_CURRENT_SOCK"
    then
        echo "dtach session cannot be nested." 1>&2
        return 1
    elif test -S "$soc"
    then
        dtach -a "$soc" -e ^^
    elif test -e "$soc"
    then
        echo "dt: File named $soc already exists and is not a socket file."
        return 1
    elif test $# -eq 0
    then
        # New session
        # if no command given invoke current shell
        DTACH_CURRENT_SOCK="$soc" dtach -c "$soc" -e ^^ "$SHELL"
    else
        # New session
        DTACH_CURRENT_SOCK="$soc" dtach -c "$soc" -e ^^ "$@"
    fi
}

__dt "$@"
